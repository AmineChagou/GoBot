<?xml version="1.0" encoding="UTF-8"?>
<domain>
	<!-- Dialogue management models, composed of three models: an action selection 
		model to find the best system action to execute, a transition model that 
		specifies how the selected action modifies the current dialogue state, and 
		a prediction model for the prior distributions on the destinations, 
		departures and next user dialogue act. -->

	<model trigger="Chat,PizzaChoice,DisplayPrice,Drinks,NbPersons">
		<!-- This model specifies the utilities of various system actions, such 
			as clarification requests (repetitions and confirmations) and 
			grounding actions. -->

		<rule>
			<case>
				<condition>
					<if var="current_step" value="Chat" />
				</condition>
				<effect util="1">
					<set var="a_m" value="Chat" />
				</effect>
			</case>
		</rule>

		<!-- If the current step is to ask for the destination, specifies the utilities 
			of a confirmation request or a grounding action using the current value of 
			the "Destination" slot -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="PizzaChoice" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(PizzaChoice,{PizzaChoice})" />
				</effect>
				<effect util="0.5">
					<set var="a_m" value="Confirm(PizzaChoice,{PizzaChoice})" />
				</effect>
			</case>
		</rule>

		<!-- If the current step is to ask for the departure, specifies the utilities 
			of a confirmation request or a grounding action using the current value of 
			the "Departure" slot -->
		
		<!-- If the current step is to ask for the flight date, specifies the utilities 
			of a confirmation request or a grounding action using the current value of 
			the "Date" slot -->

		<!-- If the current step is to ask whether to book a round-trip ticket 
			and the user answers yes, specifies the utility of asking for the return 
			date. -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="Drinks" />
					<if var="a_u" relation="contains" value="Confirm" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(Drinks)" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="current_step" value="Drinks" />
					<if var="a_u" relation="contains" value="Disconfirm" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(NoDrinks)" />
				</effect>
			</case>
		</rule>
		<rule>
			<case>
				<condition>
					<if var="current_step" value="WhichDrinks" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(WhichDrinks,{WhichDrinks})" />
				</effect>
				<effect util="0.5">
					<set var="a_m" value="Confirm(WhichDrinks,{WhichDrinks})" />
				</effect>
			</case>
		</rule>


		<!-- If the current step is to ask whether to proceed with the booking 
			and the user answers yes, specifies the utility of asking for the number 
			of tickets. -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="DisplayPrice" />
					<if var="a_u" relation="contains" value="Confirm" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(DisplayPrice)" />
				</effect>
			</case>
		</rule>

		<!-- If the current step is to ask whether to proceed with the booking 
			and the user answers no, specifies the utility of grounding the cancel action. -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="DisplayPrice" />
					<if var="a_u" relation="contains" value="Disconfirm" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(Cancel)" />
				</effect>
			</case>
		</rule>

		<!-- If the current step is to ask for the number of tickets, specifies 
			the utilities of a confirmation request or a grounding action using the current 
			value of the "NbTickets" slot -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="NbPersons" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(NbPersons,{NbPersons})" />
				</effect>
				<effect util="0.5">
					<set var="a_m" value="Confirm(NbPersons,{NbPersons})" />
				</effect>
			</case>
		</rule>

		<!-- If the current step is to ask for a last confirmation and the user 
			answers yes, specifies the utility of grounding the booking. -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="LastConfirm" />
					<if var="a_u" relation="contains" value="Confirm" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(Order)" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="current_step" value="LastConfirm" />
					<if var="a_u" relation="contains" value="Disconfirm" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(Cancel)" />
				</effect>
			</case>
		</rule>

		<!-- If the current step is to ask whether to book additional tickets and 
			the user answers yes, specifies the utility of restarting the interaction. -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="Final" />
					<if var="a_u" relation="contains" value="Confirm" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(Restart)" />
				</effect>
			</case>
		</rule>

		<!-- If the current step is to ask whether to book additional tickets and 
			the user answers no, specifies the utility of closing the interaction. -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="Final" />
					<if var="a_u" relation="contains" value="Disconfirm" />
				</condition>
				<effect util="5">
					<set var="a_m" value="Ground(Close)" />
				</effect>
			</case>
		</rule>

		<!-- Specifies the utility of a repetition request -->
		<rule>
			<case>
				<condition>
					<if var="a_u" relation="!=" value="None" />
					<if var="current_step" value="(PizzaChoice|GivePrice|Drinks|WhichDrinks|NbPersons)" />
				</condition>
				<effect util="0.1">
					<set var="a_m" value="AskRepeat" />
				</effect>
			</case>
		</rule>
		<rule>
			<case>
				<condition>
					<if var="a_u" relation="!=" value="None" />
					<if var="current_step" value="Chat" />
				</condition>
				<effect util="0.1">
					<set var="a_m" value="Chat" />
				</effect>
			</case>
		</rule>
		<!-- Specifies the "base" utility of all possible actions, in the absence 
			of any other information (allows to set an implicit threshold on the system 
			confidence before selecting a particular action). -->
		<rule>
			<case>
				<effect util="-4.5">
					<set var="a_m" value="Ground(*)" />
				</effect>
				<effect util="-0.3">
					<set var="a_m" value="Confirm(*)" />
				</effect>
				<effect util="-0.2">
					<set var="a_m" value="AskRepeat" />
				</effect>
			</case>
		</rule>
		
		
		<!-- Records the next-to-last system action -->
		<rule>
			<case>
				<effect>
					<set var="a_m-prev" value="{a_m}" />
				</effect>
			</case>
		</rule>

	</model>
	
	


	<model trigger="a_m">
		<!-- Transition model that specifies how the selection of a particular 
			system action affects the current dialogue state, in particular the current 
			step in the dialogue. -->

		
		<rule>
			<case>
				<condition>
					<if var="a_m" value="Ground(PizzaChoice,{PizzaChoice})" />
				</condition>
				<effect prob="1">
				    <set var="PizzaChoice" value="{PizzaChoice}" />
					<set var="current_step" value="NbPersons" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="a_m" value="Ground(NbPersons,{NbPersons})" />
				</condition>
				<effect prob="1">
					<set var="NbPersons" value="{NbPersons}" />
					<set var="current_step" value="Drinks" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="a_m" value="Ground(Drinks)" />
				</condition>
				<effect prob="1">
				    <set var="Drinks" value="Drinks" />
					<set var="current_step" value="WhichDrinks" />
				</effect>
			</case>		
			<case>
				<condition>
					<if var="a_m" value="Ground(NoDrinks)" />
				</condition>
				<effect prob="1">
					<set var="Drinks" value="NoDrinks" />
					<set var="a_m" value="GetPrice" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="a_m" value="Ground(WhichDrinks,{WhichDrinks})" />
				</condition>
				<effect prob="1">
				     <set var="WhichDrinks" value="{WhichDrinks}" />
					<set var="a_m" value="GetPrice" />
				</effect>
			</case>
				<case>
				<condition>
					<if var="a_m" value="Ground(Price)" />
				</condition>
				<effect prob="1">
				     <set var="Price" value="{Price}" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="a_m" value="Ground(DisplayPrice)" />
				</condition>
				<effect prob="1">
					<set var="current_step" value="LastConfirm" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="a_m" value="Ground(Cancel)" />
				</condition>
				<effect prob="1">
					<set var="current_step" value="Final" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="a_m" value="Ground(Order)" />
				</condition>
				<effect prob="1">
					<set var="a_m-prev" value="{a_m}" />
					<set var="a_m" value="Order"/>
					<set var="current_step" value="Final" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="a_m" value="Ground(Restart)" />
				</condition>
				<effect prob="1">
					<set var="current_step" value="PizzaChoice" />
					<set var="Drinks" value="None" />
					<set var="WhichDrinks" value="None" />
					<set var="NbPersons" value="None" />
					<set var="TotalCost" value="None" />
					<set var="a_u" value="None" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="a_m" value="Ground(Close)" />
				</condition>
				<effect prob="1">
					<set var="a_u" value="None"/>
					<set var="u_u_c" value="None"/>
					<set var="u_m" value="None"/>
					<set var="a_m" value="ActivateChatDomain" />
				</effect>
			</case>
		</rule>


		<!-- If the external module produces the system action MakeOffer(particular price),
		registers the price in a separate variable and moves the current step. -->
		<rule>
			<case>
				<condition>
					<if var="a_m" value="DisplayPrice({Price})" />
				</condition>
				<effect>
					<set var="current_step" value="DisplayPrice" />
					<set var="a_u" value="Inform(TotalPrice,{Price})" exclusive="false"/>
				</effect>
			</case>
	</rule>

	</model>
	
	<model trigger="a_m,current_step">
		<!-- Specifies the prior distributions for the destinations, departures and
		responses to yes/no questions -->
	
		<!-- Prior probabilities for the destinations and departures -->
		<rule>
			<case>
				<condition>
					<if var="current_step" value="PizzaChoice" />
				</condition>
				<effect prob="0.4">
					<set var="PizzaChoice^p" value="Margheritta" />
				</effect>
				<effect prob="0.3">
					<set var="PizzaChoice^p" value="forestiere" />
				</effect>
				<effect prob="0.3">
					<set var="PizzaChoice^p" value="cannibale" />
				</effect>
			</case>
			<case>
				<condition>
					<if var="current_step" value="WhichDrinks" />
				</condition>
				<effect prob="0.4">
					<set var="WhichDrinks^p" value="Water" />
				</effect>
				<effect prob="0.3">
					<set var="WhichDrinks^p" value="Coke" />
				</effect>
				<effect prob="0.3">
					<set var="WhichDrinks^p" value="Pepsi" />
				</effect>
			</case>
		</rule>
		
		
			<!-- Prediction rule on the next user dialogue act (the probabilities
		are here quite low to account for a range of unexpected responses)   -->
		<rule>
			<case>
				<condition>
					<if var="a_m" value="(AskRepeat|None)"/>
					<if var="a_u" relation="!=" value="None"/>
					<if var="a_u" relation="!=" value="[Other]"/>
				</condition>
				<effect prob="0.7">
					<set var="a_u^p" value="{a_u}"/>
				</effect>
			</case>
			<case>
				<condition operator="or">
					<if var="a_m" value="Confirm(*)"/>
					<if var="current_step" value="Drinks"/>
					<if var="current_step" value="DisplayPrice"/>
					<if var="current_step" value="LastConfirm"/>
					<if var="current_step" value="Final"/>
				</condition>
				<effect prob="0.2">
					<set var="a_u^p" value="[Confirm]"/>
				</effect>
				<effect prob="0.2">
					<set var="a_u^p" value="[Disconfirm]"/>
				</effect>
			</case>
			<case>
				<effect>
					<set var="a_u^p" value="None"/>
				</effect>
			</case>
		</rule>
		
	</model>

</domain>
